#!/bin/bash

# MySQL 8.0 å¤šå®ä¾‹è‡ªåŠ¨å®‰è£…è„šæœ¬
# æ”¯æŒ CentOS 7/8 å’Œ RHEL 7/8
# ä½œè€…: Auto-generated
# ç‰ˆæœ¬: 2.0
# 
# ä½¿ç”¨æ–¹æ³•ï¼š
#   ./install_mysql.sh [ç«¯å£å·]
#   
# ç¤ºä¾‹ï¼š
#   ./install_mysql.sh         # å®‰è£…é»˜è®¤3306ç«¯å£å®ä¾‹
#   ./install_mysql.sh 3306    # å®‰è£…3306ç«¯å£å®ä¾‹
#   ./install_mysql.sh 3307    # å®‰è£…3307ç«¯å£å®ä¾‹
#   ./install_mysql.sh 3308    # å®‰è£…3308ç«¯å£å®ä¾‹
#
# ç›®å½•ç»“æ„è¯´æ˜ï¼š
#   ç«¯å£3306ï¼ˆé»˜è®¤ï¼‰ï¼š
#     - é…ç½®æ–‡ä»¶: /etc/my.cnf
#     - æ•°æ®ç›®å½•: /data/3306/data
#     - æ—¥å¿—ç›®å½•: /data/3306/log
#   
#   å…¶ä»–ç«¯å£ï¼ˆå¦‚3307ï¼‰ï¼š
#     - é…ç½®æ–‡ä»¶: /data/3307/conf/mysql_3307.cnf
#     - æ•°æ®ç›®å½•: /data/3307/data
#     - æ—¥å¿—ç›®å½•: /data/3307/log

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# åˆå§‹åŒ–é…ç½®å˜é‡
init_config() {
    # è·å–ç«¯å£å·å‚æ•°
    MYSQL_PORT="${1:-3306}"

    # éªŒè¯ç«¯å£å·
    if ! [[ "$MYSQL_PORT" =~ ^[0-9]+$ ]] || [ "$MYSQL_PORT" -lt 1024 ] || [ "$MYSQL_PORT" -gt 65535 ]; then
        echo "é”™è¯¯: æ— æ•ˆçš„ç«¯å£å· '$MYSQL_PORT'"
        echo "ç«¯å£å·å¿…é¡»æ˜¯1024-65535ä¹‹é—´çš„æ•°å­—"
        echo ""
        echo "ä½¿ç”¨æ–¹æ³•: $0 [ç«¯å£å·]"
        echo "ç¤ºä¾‹: $0 3306"
        exit 1
    fi

    # åŸºç¡€é…ç½®å˜é‡
    MYSQL_VERSION="8.0.32"
    MYSQL_BASE_DIR="/usr/local/mysql"
    MYSQL_USER="mysql"

    # æ ¹æ®ç«¯å£å·åŠ¨æ€è®¾ç½®è·¯å¾„
    if [[ "$MYSQL_PORT" == "3306" ]]; then
        # 3306ç«¯å£ä½¿ç”¨ä¼ ç»Ÿé…ç½®
        MYSQL_DATA_DIR="/data/3306/data"
        MYSQL_LOG_DIR="/data/3306/log"
        MYSQL_CONFIG_FILE="/etc/my.cnf"
        MYSQL_SOCKET="/tmp/mysql.sock"
    else
        # å…¶ä»–ç«¯å£ä½¿ç”¨ç‹¬ç«‹ç›®å½•ç»“æ„
        MYSQL_DATA_DIR="/data/${MYSQL_PORT}/data"
        MYSQL_LOG_DIR="/data/${MYSQL_PORT}/log"
        MYSQL_CONFIG_DIR="/data/${MYSQL_PORT}/conf"
        MYSQL_CONFIG_FILE="${MYSQL_CONFIG_DIR}/mysql_${MYSQL_PORT}.cnf"
        MYSQL_SOCKET="/tmp/mysql_${MYSQL_PORT}.sock"
    fi

    # PIDå’Œæ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆç»Ÿä¸€å‘½åè§„åˆ™ï¼‰
    MYSQL_PID_FILE="${MYSQL_DATA_DIR}/mysql_${MYSQL_PORT}.pid"
    MYSQL_ERROR_LOG="${MYSQL_LOG_DIR}/mysql_${MYSQL_PORT}.err"
    MYSQL_SLOW_LOG="${MYSQL_LOG_DIR}/mysql_${MYSQL_PORT}_slow.log"
}

# æ˜¾ç¤ºå½“å‰é…ç½®
show_config() {
    echo ""
    echo "=========================================="
    echo -e "${BLUE}MySQL ${MYSQL_VERSION} å®ä¾‹é…ç½®ä¿¡æ¯${NC}"
    echo "=========================================="
    echo "ç«¯å£å·: $MYSQL_PORT"
    echo "æ•°æ®ç›®å½•: $MYSQL_DATA_DIR"
    echo "æ—¥å¿—ç›®å½•: $MYSQL_LOG_DIR"
    echo "é…ç½®æ–‡ä»¶: $MYSQL_CONFIG_FILE"
    echo "Socketæ–‡ä»¶: $MYSQL_SOCKET"
    echo "PIDæ–‡ä»¶: $MYSQL_PID_FILE"
    echo "é”™è¯¯æ—¥å¿—: $MYSQL_ERROR_LOG"
    echo "æ…¢æŸ¥è¯¢æ—¥å¿—: $MYSQL_SLOW_LOG"
    
    if [[ "$MYSQL_PORT" == "3306" ]]; then
        echo ""
        echo -e "${GREEN}æ³¨æ„: ç«¯å£3306ä½¿ç”¨ä¼ ç»Ÿé…ç½®ç»“æ„${NC}"
    else
        echo ""
        echo -e "${BLUE}æ³¨æ„: ç«¯å£${MYSQL_PORT}ä½¿ç”¨ç‹¬ç«‹ç›®å½•ç»“æ„${NC}"
        echo "é…ç½®ç›®å½•: $MYSQL_CONFIG_DIR"
    fi
    echo "=========================================="
    echo ""
    
    read -p "ç¡®è®¤ä½¿ç”¨ä»¥ä¸Šé…ç½®ç»§ç»­å®‰è£…ï¼Ÿ(y/n): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "å®‰è£…å·²å–æ¶ˆ"
        exit 0
    fi
}

# è·å–MySQLä¸‹è½½URL
get_mysql_download_url() {
    case $MYSQL_VERSION in
        "8.0.26")
            echo "https://downloads.mysql.com/archives/get/p/23/file/mysql-8.0.26-linux-glibc2.12-x86_64.tar.xz"
            ;;
        "8.0.32")
            echo "https://downloads.mysql.com/archives/get/p/23/file/mysql-8.0.32-linux-glibc2.12-x86_64.tar.xz"
            ;;
        *)
            log_error "ä¸æ”¯æŒçš„MySQLç‰ˆæœ¬: $MYSQL_VERSION"
            exit 1
            ;;
    esac
}

# æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
check_root() {
    if [[ $EUID -ne 0 ]]; then
        log_error "æ­¤è„šæœ¬éœ€è¦rootæƒé™è¿è¡Œ"
        exit 1
    fi
}

# æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬
check_system() {
    log_step "æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ"
    
    if [[ -f /etc/redhat-release ]]; then
        local version=$(cat /etc/redhat-release)
        log_info "ç³»ç»Ÿç‰ˆæœ¬: $version"
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºCentOS 8ï¼Œéœ€è¦é¢å¤–çš„åŒ…
        if echo "$version" | grep -q "release 8"; then
            CENTOS8=true
        else
            CENTOS8=false
        fi
    else
        log_error "ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼Œæ­¤è„šæœ¬ä»…æ”¯æŒCentOS/RHEL"
        exit 1
    fi
}

# ç¯å¢ƒå‡†å¤‡
prepare_environment() {
    log_step "å‡†å¤‡ç³»ç»Ÿç¯å¢ƒ"
    
    # å…³é—­SELinux
    log_info "å…³é—­SELinux"
    setenforce 0 2>/dev/null || true
    sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
    
    # å¸è½½MariaDB
    log_info "å¸è½½å·²å­˜åœ¨çš„MariaDBåŒ…"
    local mariadb_packages=$(rpm -qa | grep mariadb 2>/dev/null || true)
    if [[ -n "$mariadb_packages" ]]; then
        yum remove mariadb-libs -y 2>/dev/null || true
        log_info "å·²å¸è½½MariaDBç›¸å…³åŒ…"
    else
        log_info "æœªå‘ç°MariaDBåŒ…"
    fi
    
    # å®‰è£…ä¾èµ–åŒ…
    log_info "å®‰è£…ä¾èµ–åŒ…"
    yum install -y ncurses ncurses-devel libaio-devel openssl openssl-devel wget
    
    # CentOS 8 éœ€è¦é¢å¤–çš„åŒ…
    if [[ "$CENTOS8" == "true" ]]; then
        log_info "æ£€æµ‹åˆ°CentOS 8ï¼Œå®‰è£…é¢å¤–ä¾èµ–åŒ…"
        yum install -y ncurses-compat-libs
    fi
    
    # å…³é—­é˜²ç«å¢™
    log_info "å…³é—­é˜²ç«å¢™"
    systemctl stop firewalld 2>/dev/null || true
    systemctl disable firewalld 2>/dev/null || true
    
    log_info "ç¯å¢ƒå‡†å¤‡å®Œæˆ"
}

# åˆ›å»ºMySQLç”¨æˆ·
create_mysql_user() {
    log_step "åˆ›å»ºMySQLç”¨æˆ·"
    
    if id "$MYSQL_USER" &>/dev/null; then
        log_warn "MySQLç”¨æˆ·å·²å­˜åœ¨"
    else
        useradd "$MYSQL_USER" -s /sbin/nologin -M
        log_info "MySQLç”¨æˆ·åˆ›å»ºæˆåŠŸ"
    fi
}

# ä¸‹è½½å¹¶å®‰è£…MySQL
download_and_install_mysql() {
    log_step "ä¸‹è½½å¹¶å®‰è£…MySQL"
    
    local download_url=$(get_mysql_download_url)
    local filename="mysql-${MYSQL_VERSION}-linux-glibc2.12-x86_64.tar.xz"
    local download_path="/usr/local/$filename"
    
    # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨MySQLç›®å½•
    if [[ -d "$MYSQL_BASE_DIR" ]]; then
        log_warn "MySQLç›®å½•å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½"
    else
        # ä¸‹è½½MySQL
        log_info "å¼€å§‹ä¸‹è½½MySQL $MYSQL_VERSION"
        if [[ ! -f "$download_path" ]]; then
            wget -P /usr/local "$download_url"
            log_info "MySQLä¸‹è½½å®Œæˆ"
        else
            log_info "MySQLå®‰è£…åŒ…å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸‹è½½"
        fi
        
        # è§£å‹MySQL
        log_info "è§£å‹MySQLå®‰è£…åŒ…"
        cd /usr/local
        tar xf "$filename"
        
        # åˆ›å»ºè½¯é“¾æ¥
        ln -sf "/usr/local/mysql-${MYSQL_VERSION}-linux-glibc2.12-x86_64" "$MYSQL_BASE_DIR"
        log_info "MySQLè½¯é“¾æ¥åˆ›å»ºå®Œæˆ"
    fi
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    log_info "é…ç½®ç¯å¢ƒå˜é‡"
    if ! grep -q "export PATH=\"$MYSQL_BASE_DIR/bin:\$PATH\"" /etc/profile; then
        echo "export PATH=\"$MYSQL_BASE_DIR/bin:\$PATH\"" >> /etc/profile
    fi
    
    # ä¸ºå½“å‰ä¼šè¯è®¾ç½®PATH
    export PATH="$MYSQL_BASE_DIR/bin:$PATH"
    
    # éªŒè¯å®‰è£…
    if [[ -f "$MYSQL_BASE_DIR/bin/mysql" ]]; then
        local mysql_version_output=$($MYSQL_BASE_DIR/bin/mysql -V)
        log_info "MySQLç‰ˆæœ¬ä¿¡æ¯: $mysql_version_output"
        log_info "MySQLäºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„: $MYSQL_BASE_DIR/bin"
    else
        log_error "MySQLå®‰è£…éªŒè¯å¤±è´¥ï¼Œæ‰¾ä¸åˆ°mysqlå‘½ä»¤"
        exit 1
    fi
}

# åˆ›å»ºæ•°æ®ç›®å½•å’Œé…ç½®æ–‡ä»¶
setup_mysql_config() {
    log_step "åˆ›å»ºç›®å½•ç»“æ„å’Œé…ç½®æ–‡ä»¶"
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    log_info "åˆ›å»ºMySQLç›®å½•ç»“æ„"
    mkdir -pv "$MYSQL_DATA_DIR"
    mkdir -pv "$MYSQL_LOG_DIR"
    
    # å¦‚æœä¸æ˜¯3306ç«¯å£ï¼Œåˆ›å»ºé…ç½®ç›®å½•
    if [[ "$MYSQL_PORT" != "3306" ]]; then
        mkdir -pv "$MYSQL_CONFIG_DIR"
    fi
    
    # è®¾ç½®ç›®å½•æƒé™
    chown -R "$MYSQL_USER:$MYSQL_USER" "/data/${MYSQL_PORT}"
    
    # åˆ›å»ºé…ç½®æ–‡ä»¶
    log_info "åˆ›å»ºMySQLé…ç½®æ–‡ä»¶: $MYSQL_CONFIG_FILE"
    
    # é…ç½®æ–‡ä»¶ç›®å½•æƒé™ï¼ˆå¦‚æœä¸æ˜¯/etcç›®å½•ï¼‰
    if [[ "$MYSQL_PORT" != "3306" ]]; then
        chown -R "$MYSQL_USER:$MYSQL_USER" "$MYSQL_CONFIG_DIR"
    fi
    
    cat > "$MYSQL_CONFIG_FILE" <<EOF
[mysqld]
user=$MYSQL_USER
basedir=$MYSQL_BASE_DIR
datadir=$MYSQL_DATA_DIR
port=$MYSQL_PORT
socket=$MYSQL_SOCKET
pid-file=$MYSQL_PID_FILE

# å®‰å…¨è®¾ç½®
skip-name-resolve
default-authentication-plugin=mysql_native_password
bind-address=0.0.0.0

# å­—ç¬¦é›†è®¾ç½®
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# InnoDBè®¾ç½®
innodb_buffer_pool_size=256M
innodb_log_file_size=64M
innodb_flush_log_at_trx_commit=1
innodb_lock_wait_timeout=50
innodb_file_per_table=1

# è¿æ¥è®¾ç½®
max_connections=200
max_connect_errors=10
wait_timeout=28800
interactive_timeout=28800

# æ—¥å¿—è®¾ç½®
log-error=$MYSQL_ERROR_LOG
slow_query_log=1
slow_query_log_file=$MYSQL_SLOW_LOG
long_query_time=2

# æ€§èƒ½è®¾ç½®
query_cache_type=0
query_cache_size=0

[client]
socket=$MYSQL_SOCKET
default-character-set=utf8mb4
port=$MYSQL_PORT

[mysql]
default-character-set=utf8mb4

[mysqldump]
default-character-set=utf8mb4
EOF
    
    log_info "MySQLé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
    
    # æ˜¾ç¤ºé…ç½®æ–‡ä»¶å†…å®¹
    echo ""
    log_info "MySQLé…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
    echo "----------------------------------------"
    cat "$MYSQL_CONFIG_FILE"
    echo "----------------------------------------"
    echo ""
    log_info "é…ç½®æ–‡ä»¶æ˜¾ç¤ºå®Œæˆï¼Œ3ç§’åç»§ç»­..."
    sleep 3
}

# åˆå§‹åŒ–MySQLæ•°æ®åº“
initialize_mysql() {
    log_step "åˆå§‹åŒ–MySQLæ•°æ®åº“"
    
    # æ£€æŸ¥æ•°æ®ç›®å½•æ˜¯å¦å·²ç»åˆå§‹åŒ–
    if [[ -f "$MYSQL_DATA_DIR/mysql/user.frm" ]] || [[ -f "$MYSQL_DATA_DIR/mysql.ibd" ]]; then
        log_warn "MySQLæ•°æ®åº“å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡åˆå§‹åŒ–æ­¥éª¤"
        return 0
    fi
    
    log_info "å¼€å§‹åˆå§‹åŒ–MySQLæ•°æ®åº“ï¼ˆä½¿ç”¨ç©ºå¯†ç ï¼‰"
    
    # ç¡®ä¿PATHåŒ…å«MySQLäºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„
    export PATH="$MYSQL_BASE_DIR/bin:$PATH"
    
    # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
    chown -R "$MYSQL_USER:$MYSQL_USER" "/data/${MYSQL_PORT}"
    
    # åˆå§‹åŒ–æ•°æ®åº“ - ä¸ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œé¿å…é…ç½®å†²çª
    log_info "æ‰§è¡ŒMySQLåˆå§‹åŒ–å‘½ä»¤"
    "$MYSQL_BASE_DIR/bin/mysqld" --initialize-insecure \
        --user="$MYSQL_USER" \
        --basedir="$MYSQL_BASE_DIR" \
        --datadir="$MYSQL_DATA_DIR"
    
    # æ£€æŸ¥åˆå§‹åŒ–æ˜¯å¦æˆåŠŸ
    if [[ $? -eq 0 ]]; then
        log_info "MySQLæ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
        log_warn "æ³¨æ„: rootç”¨æˆ·åˆå§‹å¯†ç ä¸ºç©ºï¼Œè¯·åœ¨å¯åŠ¨åç«‹å³è®¾ç½®å¯†ç ï¼"
    else
        log_error "MySQLæ•°æ®åº“åˆå§‹åŒ–å¤±è´¥"
        exit 1
    fi
}

# é…ç½®MySQLå¯åŠ¨è„šæœ¬
setup_mysql_service() {
    log_step "é…ç½®MySQLå¯åŠ¨è„šæœ¬"
    
    # å¤åˆ¶å¯åŠ¨è„šæœ¬
    if [[ -f "$MYSQL_BASE_DIR/support-files/mysql.server" ]]; then
        cp "$MYSQL_BASE_DIR/support-files/mysql.server" /etc/init.d/mysqld
        chmod +x /etc/init.d/mysqld
        
        # è®¾ç½®å¼€æœºè‡ªå¯
        /sbin/chkconfig mysqld on
        log_info "MySQLå¯åŠ¨è„šæœ¬é…ç½®å®Œæˆ"
    else
        log_error "æ‰¾ä¸åˆ°MySQLå¯åŠ¨è„šæœ¬"
        exit 1
    fi
}

# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
create_systemd_service() {
    log_step "åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶"
    
    log_info "æ£€æµ‹åˆ°systemdç³»ç»Ÿï¼Œæ­£åœ¨åˆ›å»ºMySQL systemdæœåŠ¡æ–‡ä»¶"
    
    # åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
    cat > /etc/systemd/system/mysqld_${MYSQL_PORT}.service <<EOF
[Unit]
Description=MySQL Community Server (Port $MYSQL_PORT)
Documentation=man:mysqld(8)
Documentation=http://dev.mysql.com/doc/refman/en/using-systemd.html
After=network.target
After=syslog.target

[Install]
WantedBy=multi-user.target

[Service]
User=$MYSQL_USER
Group=$MYSQL_USER

# æœåŠ¡ç±»å‹ä¸ºforkingï¼Œå› ä¸ºmysqld_safeä¼šforkå‡ºmysqldè¿›ç¨‹
Type=forking

# PIDæ–‡ä»¶è·¯å¾„ - åŒ…å«ç«¯å£å·æ”¯æŒå¤šå®ä¾‹
PIDFile=$MYSQL_PID_FILE

# å¯åŠ¨å‰çš„å‡†å¤‡å·¥ä½œ
ExecStartPre=/usr/bin/mkdir -p $MYSQL_DATA_DIR
ExecStartPre=/usr/bin/mkdir -p $MYSQL_LOG_DIR
ExecStartPre=/usr/bin/chown -R $MYSQL_USER:$MYSQL_USER /data/${MYSQL_PORT}
ExecStartPre=/usr/bin/touch $MYSQL_PID_FILE
ExecStartPre=/usr/bin/chown $MYSQL_USER:$MYSQL_USER $MYSQL_PID_FILE

# å¯åŠ¨å‘½ä»¤ - ä½¿ç”¨mysqld_safeå¯åŠ¨
ExecStart=$MYSQL_BASE_DIR/bin/mysqld_safe --defaults-file=$MYSQL_CONFIG_FILE --pid-file=$MYSQL_PID_FILE --daemonize

# åœæ­¢å‘½ä»¤ - ä½¿ç”¨mysqladminå®‰å…¨å…³é—­
ExecStop=$MYSQL_BASE_DIR/bin/mysqladmin -u root -S $MYSQL_SOCKET shutdown

# é‡æ–°åŠ è½½é…ç½®
ExecReload=/bin/kill -HUP \$MAINPID

# é‡å¯ç­–ç•¥
Restart=on-failure
RestartPreventExitStatus=1

# è¶…æ—¶è®¾ç½® - å¢åŠ å¯åŠ¨è¶…æ—¶æ—¶é—´
TimeoutStartSec=300
TimeoutStopSec=120

# å®‰å…¨è®¾ç½®
PrivateTmp=false
PrivateNetwork=false
PrivateDevices=false

# èµ„æºé™åˆ¶
LimitNOFILE=65535
LimitNPROC=65535

# å·¥ä½œç›®å½•
WorkingDirectory=$MYSQL_BASE_DIR

# ç¯å¢ƒå˜é‡
Environment=PATH=$MYSQL_BASE_DIR/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
EOF

    log_info "systemdæœåŠ¡æ–‡ä»¶åˆ›å»ºå®Œæˆ: /etc/systemd/system/mysqld_${MYSQL_PORT}.service"
    
    # æ˜¾ç¤ºæœåŠ¡æ–‡ä»¶å†…å®¹
    echo ""
    log_info "MySQL systemdæœåŠ¡æ–‡ä»¶å†…å®¹ï¼š"
    echo "----------------------------------------"
    cat /etc/systemd/system/mysqld_${MYSQL_PORT}.service
    echo "----------------------------------------"
    echo ""
    
    # é‡æ–°åŠ è½½systemdé…ç½®
    log_info "é‡æ–°åŠ è½½systemdé…ç½®"
    systemctl daemon-reload
    
    log_info "systemdæœåŠ¡é…ç½®å®Œæˆï¼Œ3ç§’åç»§ç»­..."
    sleep 3
}

# é…ç½®systemdæœåŠ¡ï¼ˆå¯é€‰ï¼‰
setup_systemd_service() {
    log_step "é…ç½®MySQLæœåŠ¡å¯åŠ¨æ–¹å¼"
    
    # å®šä¹‰æœåŠ¡åç§°ï¼ˆåŒ…å«ç«¯å£å·ï¼‰
    local service_name="mysqld_${MYSQL_PORT}"
    
    # æ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æ”¯æŒsystemd
    if command -v systemctl >/dev/null 2>&1 && [[ -d /etc/systemd/system ]]; then
        echo ""
        echo -e "${YELLOW}æ£€æµ‹åˆ°systemdç³»ç»Ÿï¼Œè¯·é€‰æ‹©MySQLæœåŠ¡ç®¡ç†æ–¹å¼ï¼š${NC}"
        echo "1) åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶ (æ¨è) - ä½¿ç”¨systemctlç®¡ç†"
        echo "2) ä»…ä½¿ç”¨ä¼ ç»Ÿinit.dè„šæœ¬ - ä½¿ç”¨serviceå‘½ä»¤ç®¡ç†"
        echo "3) ä¸¤ç§æ–¹å¼éƒ½é…ç½® - æœ€å¤§å…¼å®¹æ€§"
        echo ""
        read -p "è¯·è¾“å…¥é€‰æ‹© (1/2/3): " choice
        
        case "$choice" in
            1)
                log_info "é€‰æ‹©åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶"
                create_systemd_service
                
                # å°è¯•å¯ç”¨systemdæœåŠ¡
                log_info "å¯ç”¨MySQL systemdæœåŠ¡: $service_name"
                if systemctl enable "$service_name"; then
                    log_info "systemdæœåŠ¡å¯ç”¨æˆåŠŸï¼"
                    echo ""
                    echo -e "${GREEN}å¯ä»¥ä½¿ç”¨ä»¥ä¸‹systemctlå‘½ä»¤ç®¡ç†MySQL (ç«¯å£$MYSQL_PORT)ï¼š${NC}"
                    echo "  å¯åŠ¨: systemctl start $service_name"
                    echo "  åœæ­¢: systemctl stop $service_name"
                    echo "  é‡å¯: systemctl restart $service_name"
                    echo "  çŠ¶æ€: systemctl status $service_name"
                    echo "  å¼€æœºè‡ªå¯: systemctl enable $service_name"
                else
                    log_error "systemdæœåŠ¡å¯ç”¨å¤±è´¥"
                    # å›é€€åˆ°chkconfigæ–¹å¼
                    log_info "å›é€€åˆ°chkconfigæ–¹å¼"
                    /sbin/chkconfig mysqld on
                fi
                ;;
            2)
                log_info "é€‰æ‹©ä»…ä½¿ç”¨ä¼ ç»Ÿinit.dè„šæœ¬"
                /sbin/chkconfig mysqld on
                log_info "å·²é€šè¿‡chkconfigå¯ç”¨MySQLæœåŠ¡"
                ;;
            3)
                log_info "é€‰æ‹©é…ç½®ä¸¤ç§å¯åŠ¨æ–¹å¼"
                create_systemd_service
                
                # å…ˆå°è¯•systemdæ–¹å¼
                if systemctl enable "$service_name" 2>/dev/null; then
                    log_info "systemdæœåŠ¡å¯ç”¨æˆåŠŸ"
                else
                    log_warn "systemdå¯ç”¨å¤±è´¥ï¼Œä½¿ç”¨chkconfigä½œä¸ºå¤‡é€‰"
                    /sbin/chkconfig mysqld on
                fi
                
                log_info "ä¸¤ç§å¯åŠ¨æ–¹å¼éƒ½å·²é…ç½®å®Œæˆ"
                ;;
            *)
                log_warn "æ— æ•ˆé€‰æ‹©ï¼Œä½¿ç”¨é»˜è®¤çš„chkconfigæ–¹å¼"
                /sbin/chkconfig mysqld on
                ;;
        esac
    else
        log_info "æœªæ£€æµ‹åˆ°systemdï¼Œä½¿ç”¨ä¼ ç»Ÿçš„chkconfigæ–¹å¼"
        /sbin/chkconfig mysqld on
    fi
    
    echo ""
    log_info "æœåŠ¡é…ç½®å®Œæˆï¼Œç»§ç»­å®‰è£…æµç¨‹..."
    sleep 2
}

# å¯åŠ¨MySQLæœåŠ¡
start_mysql() {
    log_step "å¯åŠ¨MySQLæœåŠ¡"
    
    # æ£€æŸ¥MySQLæ˜¯å¦å·²ç»åœ¨è¿è¡Œ
    if pgrep -f mysqld >/dev/null; then
        log_warn "MySQLæœåŠ¡å·²ç»åœ¨è¿è¡Œ"
        return 0
    fi
    
    # å®šä¹‰æœåŠ¡åç§°
    local service_name="mysqld_${MYSQL_PORT}"
    
    # æ£€æŸ¥æ˜¯å¦å­˜åœ¨systemdæœåŠ¡æ–‡ä»¶
    if [[ -f "/etc/systemd/system/${service_name}.service" ]] && command -v systemctl >/dev/null 2>&1; then
        log_info "ä½¿ç”¨systemdæ–¹å¼å¯åŠ¨MySQLæœåŠ¡: $service_name"
        
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§PIDæ–‡ä»¶
        if [[ -f "$MYSQL_PID_FILE" ]]; then
            log_info "æ¸…ç†æ—§çš„PIDæ–‡ä»¶: $MYSQL_PID_FILE"
            rm -f "$MYSQL_PID_FILE"
        fi
        
        # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
        chown -R "$MYSQL_USER:$MYSQL_USER" "/data/${MYSQL_PORT}"
        
        # ä½¿ç”¨systemctlå¯åŠ¨
        log_info "æ‰§è¡Œ: systemctl start $service_name"
        if systemctl start "$service_name"; then
            log_info "MySQLæœåŠ¡é€šè¿‡systemdå¯åŠ¨æˆåŠŸ"
        else
            log_error "systemdå¯åŠ¨å¤±è´¥ï¼Œå¼€å§‹æ•…éšœæ’é™¤"
            troubleshoot_mysql_startup
            return 1
        fi
    else
        log_info "ä½¿ç”¨ä¼ ç»Ÿinit.dæ–¹å¼å¯åŠ¨MySQLæœåŠ¡"
        /etc/init.d/mysqld start
    fi
    
    # ç­‰å¾…MySQLå¯åŠ¨å®Œæˆ
    local retry_count=0
    local max_retries=60  # å¢åŠ é‡è¯•æ¬¡æ•°
    
    log_info "ç­‰å¾…MySQLå®Œå…¨å¯åŠ¨..."
    while [[ $retry_count -lt $max_retries ]]; do
        if "$MYSQL_BASE_DIR/bin/mysqladmin" ping -h localhost >/dev/null 2>&1; then
            log_info "MySQLæœåŠ¡å¯åŠ¨æˆåŠŸ"
            
            # æ˜¾ç¤ºMySQLè¿›ç¨‹ä¿¡æ¯
            echo ""
            log_info "MySQLè¿›ç¨‹ä¿¡æ¯ï¼š"
            ps aux | grep -E '[m]ysql' | head -5
            echo ""
            
            # æ˜¾ç¤ºç«¯å£ç›‘å¬æƒ…å†µ
            log_info "MySQLç«¯å£ç›‘å¬æƒ…å†µï¼š"
            netstat -tlnp 2>/dev/null | grep ":$MYSQL_PORT " || ss -tlnp | grep ":$MYSQL_PORT "
            echo ""
            
            # æ£€æŸ¥systemdæœåŠ¡çŠ¶æ€
            if [[ -f "/etc/systemd/system/${service_name}.service" ]]; then
                echo ""
                log_info "systemdæœåŠ¡çŠ¶æ€ï¼š"
                systemctl status "$service_name" --no-pager -l
                echo ""
            fi
            
            return 0
        fi
        
        log_info "ç­‰å¾…MySQLå¯åŠ¨... ($((retry_count + 1))/$max_retries)"
        sleep 2
        ((retry_count++))
    done
    
    log_error "MySQLå¯åŠ¨è¶…æ—¶ï¼Œå¼€å§‹æ•…éšœæ’é™¤"
    troubleshoot_mysql_startup
    exit 1
}

# MySQLå¯åŠ¨æ•…éšœæ’é™¤å‡½æ•°
troubleshoot_mysql_startup() {
    log_step "MySQLå¯åŠ¨æ•…éšœæ’é™¤"
    
    local service_name="mysqld_${MYSQL_PORT}"
    
    echo ""
    echo "=========================================="
    echo -e "${RED}MySQLå¯åŠ¨å¤±è´¥ï¼Œå¼€å§‹æ•…éšœæ’é™¤${NC}"
    echo "=========================================="
    echo ""
    
    # 1. æ£€æŸ¥systemdæœåŠ¡çŠ¶æ€
    if [[ -f "/etc/systemd/system/${service_name}.service" ]]; then
        echo "1. systemdæœåŠ¡çŠ¶æ€ ($service_name)ï¼š"
        systemctl status "$service_name" --no-pager -l || true
        echo ""
        
        echo "2. systemdæ—¥å¿— (æœ€è¿‘50è¡Œ)ï¼š"
        journalctl -u "$service_name" -n 50 --no-pager || true
        echo ""
    fi
    
    # 2. æ£€æŸ¥MySQLé”™è¯¯æ—¥å¿—
    if [[ -f "$MYSQL_ERROR_LOG" ]]; then
        echo "3. MySQLé”™è¯¯æ—¥å¿— (æœ€å30è¡Œ)ï¼š"
        echo "   æ–‡ä»¶ä½ç½®: $MYSQL_ERROR_LOG"
        tail -30 "$MYSQL_ERROR_LOG" 2>/dev/null || echo "   æ— æ³•è¯»å–é”™è¯¯æ—¥å¿—æ–‡ä»¶"
        echo ""
    else
        echo "3. MySQLé”™è¯¯æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $MYSQL_ERROR_LOG"
        echo ""
    fi
    
    # 3. æ£€æŸ¥PIDæ–‡ä»¶
    echo "4. PIDæ–‡ä»¶æ£€æŸ¥ï¼š"
    if [[ -f "$MYSQL_PID_FILE" ]]; then
        echo "   PIDæ–‡ä»¶å­˜åœ¨: $MYSQL_PID_FILE"
        echo "   PIDå†…å®¹: $(cat "$MYSQL_PID_FILE" 2>/dev/null || echo 'æ— æ³•è¯»å–')"
        local pid_content=$(cat "$MYSQL_PID_FILE" 2>/dev/null)
        if [[ -n "$pid_content" ]] && kill -0 "$pid_content" 2>/dev/null; then
            echo "   è¿›ç¨‹ $pid_content ä»åœ¨è¿è¡Œ"
        else
            echo "   PIDæ–‡ä»¶ä¸­çš„è¿›ç¨‹å·²ä¸å­˜åœ¨"
        fi
    else
        echo "   PIDæ–‡ä»¶ä¸å­˜åœ¨: $MYSQL_PID_FILE"
    fi
    echo ""
    
    # 4. æ£€æŸ¥ç«¯å£å ç”¨
    echo "5. ç«¯å£å ç”¨æ£€æŸ¥ï¼š"
    local port_check=$(netstat -tlnp 2>/dev/null | grep ":$MYSQL_PORT " || ss -tlnp 2>/dev/null | grep ":$MYSQL_PORT " || echo "ç«¯å£æœªè¢«å ç”¨")
    echo "   ç«¯å£ $MYSQL_PORT: $port_check"
    echo ""
    
    # 5. æ£€æŸ¥æ•°æ®ç›®å½•æƒé™
    echo "6. æ•°æ®ç›®å½•æƒé™æ£€æŸ¥ï¼š"
    echo "   æ•°æ®ç›®å½•: $MYSQL_DATA_DIR"
    if [[ -d "$MYSQL_DATA_DIR" ]]; then
        echo "   æƒé™ä¿¡æ¯: $(ls -ld "$MYSQL_DATA_DIR")"
        echo "   æ‰€æœ‰è€…: $(stat -c '%U:%G' "$MYSQL_DATA_DIR" 2>/dev/null || echo 'æ— æ³•è·å–')"
    else
        echo "   æ•°æ®ç›®å½•ä¸å­˜åœ¨ï¼"
    fi
    echo ""
    
    # 6. æ£€æŸ¥MySQLè¿›ç¨‹
    echo "7. MySQLè¿›ç¨‹æ£€æŸ¥ï¼š"
    local mysql_processes=$(ps aux | grep -E '[m]ysql' || echo "æœªå‘ç°MySQLè¿›ç¨‹")
    echo "$mysql_processes"
    echo ""
    
    # 7. æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo "8. ç£ç›˜ç©ºé—´æ£€æŸ¥ï¼š"
    df -h "$MYSQL_DATA_DIR" 2>/dev/null || df -h /
    echo ""
    
    # 8. æ£€æŸ¥é…ç½®æ–‡ä»¶
    echo "9. é…ç½®æ–‡ä»¶æ£€æŸ¥ï¼š"
    if [[ -f "$MYSQL_CONFIG_FILE" ]]; then
        echo "   é…ç½®æ–‡ä»¶å­˜åœ¨: $MYSQL_CONFIG_FILE"
        echo "   æƒé™ä¿¡æ¯: $(ls -l "$MYSQL_CONFIG_FILE")"
    else
        echo "   é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $MYSQL_CONFIG_FILE"
    fi
    echo ""
    
    # 9. æä¾›è§£å†³å»ºè®®
    echo "=========================================="
    echo -e "${YELLOW}å¸¸è§è§£å†³æ–¹æ¡ˆ${NC}"
    echo "=========================================="
    echo ""
    echo "1. æ£€æŸ¥é”™è¯¯æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼š"
    echo "   tail -f $MYSQL_ERROR_LOG"
    echo ""
    echo "2. ç¡®ä¿æ•°æ®ç›®å½•æƒé™æ­£ç¡®ï¼š"
    echo "   chown -R mysql:mysql /data/${MYSQL_PORT}"
    echo ""
    echo "3. å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œé‡æ–°åˆå§‹åŒ–ï¼š"
    echo "   rm -rf $MYSQL_DATA_DIR/*"
    echo "   $MYSQL_BASE_DIR/bin/mysqld --initialize-insecure --user=mysql --basedir=$MYSQL_BASE_DIR --datadir=$MYSQL_DATA_DIR"
    echo ""
    echo "4. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•ï¼š"
    echo "   sudo -u mysql $MYSQL_BASE_DIR/bin/mysqld_safe --defaults-file=$MYSQL_CONFIG_FILE &"
    echo ""
    echo "5. æ£€æŸ¥ç«¯å£å†²çªï¼š"
    echo "   netstat -tlnp | grep $MYSQL_PORT"
    echo ""
    echo "6. æŸ¥çœ‹å®Œæ•´çš„å¯åŠ¨æ—¥å¿—ï¼š"
    if [[ -f "/etc/systemd/system/${service_name}.service" ]]; then
        echo "   journalctl -u $service_name -f"
    else
        echo "   tail -f $MYSQL_ERROR_LOG"
    fi
    echo ""
}

# å®‰å…¨é…ç½®æé†’
security_reminder() {
    log_step "å®‰è£…å®Œæˆ - å®‰å…¨é…ç½®æé†’"
    
    echo ""
    echo "=========================================="
    echo -e "${GREEN}ğŸ‰ MySQL ${MYSQL_VERSION} å®‰è£…æˆåŠŸï¼${NC}"
    echo "=========================================="
    echo ""
    echo -e "${YELLOW}ğŸ“‹ å®ä¾‹é…ç½®ä¿¡æ¯${NC}"
    echo "----------------------------------------"
    echo "â€¢ MySQLç‰ˆæœ¬: $MYSQL_VERSION"
    echo "â€¢ ç«¯å£å·: $MYSQL_PORT"
    echo "â€¢ å®‰è£…ç›®å½•: $MYSQL_BASE_DIR"
    echo "â€¢ æ•°æ®ç›®å½•: $MYSQL_DATA_DIR"
    echo "â€¢ æ—¥å¿—ç›®å½•: $MYSQL_LOG_DIR"
    echo "â€¢ é…ç½®æ–‡ä»¶: $MYSQL_CONFIG_FILE"
    echo "â€¢ Socketæ–‡ä»¶: $MYSQL_SOCKET"
    echo "â€¢ PIDæ–‡ä»¶: $MYSQL_PID_FILE"
    echo "â€¢ é”™è¯¯æ—¥å¿—: $MYSQL_ERROR_LOG"
    echo "â€¢ æ…¢æŸ¥è¯¢æ—¥å¿—: $MYSQL_SLOW_LOG"
    
    if [[ "$MYSQL_PORT" == "3306" ]]; then
        echo ""
        echo -e "${GREEN}âœ¨ æ ‡å‡†å®ä¾‹é…ç½® (ç«¯å£3306)${NC}"
    else
        echo ""
        echo -e "${BLUE}ğŸ”§ ç‹¬ç«‹å®ä¾‹é…ç½® (ç«¯å£${MYSQL_PORT})${NC}"
        echo "â€¢ é…ç½®ç›®å½•: $MYSQL_CONFIG_DIR"
    fi
    
    echo ""
    echo -e "${RED}ğŸ” å®‰å…¨æé†’ï¼ˆé‡è¦ï¼ï¼‰${NC}"
    echo "----------------------------------------"
    echo "1. rootç”¨æˆ·å½“å‰å¯†ç ä¸ºç©ºï¼Œè¯·ç«‹å³è®¾ç½®å¯†ç ï¼š"
    echo "   mysql -u root -S $MYSQL_SOCKET"
    echo "   ALTER USER 'root'@'localhost' IDENTIFIED BY 'ä½ çš„å¼ºå¯†ç ';"
    echo "   FLUSH PRIVILEGES;"
    echo ""
    echo "2. å»ºè®®è¿è¡ŒMySQLå®‰å…¨é…ç½®å‘å¯¼ï¼š"
    echo "   mysql_secure_installation --socket=$MYSQL_SOCKET"
    echo ""
    
    # æœåŠ¡ç®¡ç†å‘½ä»¤
    echo "3. MySQLæœåŠ¡ç®¡ç†å‘½ä»¤ï¼š"
    local service_name="mysqld_${MYSQL_PORT}"
    if [[ -f "/etc/systemd/system/${service_name}.service" ]] && systemctl is-enabled "$service_name" &>/dev/null; then
        echo -e "   ${GREEN}(æ¨èä½¿ç”¨systemdæ–¹å¼)${NC}"
        echo "   å¯åŠ¨: systemctl start $service_name"
        echo "   åœæ­¢: systemctl stop $service_name"
        echo "   é‡å¯: systemctl restart $service_name"
        echo "   çŠ¶æ€: systemctl status $service_name"
        echo "   æŸ¥çœ‹æ—¥å¿—: journalctl -u $service_name -f"
        echo ""
        echo "   ä¼ ç»Ÿæ–¹å¼ä»ç„¶å¯ç”¨:"
        echo "   å¯åŠ¨: /etc/init.d/mysqld start"
        echo "   åœæ­¢: /etc/init.d/mysqld stop"
        echo "   é‡å¯: /etc/init.d/mysqld restart"
    else
        echo -e "   ${YELLOW}(ä½¿ç”¨ä¼ ç»Ÿinit.dæ–¹å¼)${NC}"
        echo "   å¯åŠ¨: /etc/init.d/mysqld start æˆ– service mysqld start"
        echo "   åœæ­¢: /etc/init.d/mysqld stop æˆ– service mysqld stop"
        echo "   é‡å¯: /etc/init.d/mysqld restart æˆ– service mysqld restart"
    fi
    
    echo ""
    echo -e "${BLUE}ğŸ”§ æ•…éšœæ’é™¤${NC}"
    echo "----------------------------------------"
    echo "å¦‚æœMySQLå¯åŠ¨å¤±è´¥ï¼Œå¯ä»¥ï¼š"
    echo "1. æ£€æŸ¥é”™è¯¯æ—¥å¿—: tail -f $MYSQL_ERROR_LOG"
    if [[ -f "/etc/systemd/system/${service_name}.service" ]]; then
        echo "2. æŸ¥çœ‹systemdæ—¥å¿—: journalctl -u $service_name -f"
    fi
    echo "3. æ£€æŸ¥ç«¯å£å ç”¨: netstat -tlnp | grep $MYSQL_PORT"
    echo "4. éªŒè¯ç›®å½•æƒé™: ls -la /data/${MYSQL_PORT}"
    echo "5. æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•: sudo -u mysql $MYSQL_BASE_DIR/bin/mysqld_safe --defaults-file=$MYSQL_CONFIG_FILE &"
    echo ""
    echo -e "${GREEN}âœ… æµ‹è¯•è¿æ¥${NC}"
    echo "----------------------------------------"
    echo "æµ‹è¯•MySQLè¿æ¥ï¼š"
    echo "  Socketè¿æ¥: mysql -u root -S $MYSQL_SOCKET"
    echo "  TCPè¿æ¥: mysql -u root -h 127.0.0.1 -P $MYSQL_PORT"
    echo "  æ£€æŸ¥ç‰ˆæœ¬: mysql -u root -S $MYSQL_SOCKET -e 'SELECT VERSION();'"
    echo "  æŸ¥çœ‹æ•°æ®åº“: mysql -u root -S $MYSQL_SOCKET -e 'SHOW DATABASES;'"
    echo ""
    
    # å¤šå®ä¾‹å¿«é€Ÿéƒ¨ç½²æŒ‡å—
    echo "=========================================="
    echo -e "${BLUE}ğŸš€ å¤šå®ä¾‹å¿«é€Ÿéƒ¨ç½²æŒ‡å—${NC}"
    echo "=========================================="
    echo ""
    echo "å®‰è£…å…¶ä»–ç«¯å£å®ä¾‹ï¼š"
    echo "  $0 3307    # å®‰è£…3307ç«¯å£å®ä¾‹"
    echo "  $0 3308    # å®‰è£…3308ç«¯å£å®ä¾‹"
    echo ""
    echo "ä¸åŒå®ä¾‹çš„ç›®å½•ç»“æ„ï¼š"
    echo "  ç«¯å£3306: /etc/my.cnf (ä¼ ç»Ÿé…ç½®)"
    echo "  ç«¯å£3307: /data/3307/{data,conf,log}"
    echo "  ç«¯å£3308: /data/3308/{data,conf,log}"
    echo ""
    echo "å¤šå®ä¾‹ç®¡ç†ï¼š"
    echo "  systemctl start mysqld_3306    # å¯åŠ¨3306"
    echo "  systemctl start mysqld_3307    # å¯åŠ¨3307"
    echo "  mysql -S /tmp/mysql.sock        # è¿æ¥3306"
    echo "  mysql -S /tmp/mysql_3307.sock   # è¿æ¥3307"
    echo ""
    echo "=========================================="
    echo -e "${GREEN}å®‰è£…å®Œæˆï¼ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼${NC}"
    echo "=========================================="
}

# ä¸»å‡½æ•°
main() {
    # åˆå§‹åŒ–é…ç½®å˜é‡
    init_config "$1"
    
    log_info "å¼€å§‹MySQL ${MYSQL_VERSION} è‡ªåŠ¨å®‰è£… (ç«¯å£: $MYSQL_PORT)"
    
    # æ˜¾ç¤ºé…ç½®å¹¶ç¡®è®¤
    show_config
    
    check_root
    check_system
    prepare_environment
    create_mysql_user
    download_and_install_mysql
    setup_mysql_config
    initialize_mysql
    
    log_info "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼Œç»§ç»­é…ç½®æœåŠ¡..."
    
    setup_mysql_service
    setup_systemd_service
    start_mysql
    security_reminder
    
    log_info "MySQL ${MYSQL_VERSION} å®‰è£…å®Œæˆï¼"
}

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    # æ˜¾ç¤ºè„šæœ¬ä¿¡æ¯
    echo ""
    echo "=========================================="
    echo -e "${GREEN}MySQL ${MYSQL_VERSION:-8.0.32} å¤šå®ä¾‹å®‰è£…è„šæœ¬${NC}"
    echo "=========================================="
    echo "ä½¿ç”¨æ–¹æ³•: $0 [ç«¯å£å·]"
    echo "é»˜è®¤ç«¯å£: 3306"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0         # å®‰è£…3306ç«¯å£å®ä¾‹"
    echo "  $0 3306    # å®‰è£…3306ç«¯å£å®ä¾‹" 
    echo "  $0 3307    # å®‰è£…3307ç«¯å£å®ä¾‹"
    echo "  $0 3308    # å®‰è£…3308ç«¯å£å®ä¾‹"
    echo "=========================================="
    echo ""
    
    main "$@"
fi